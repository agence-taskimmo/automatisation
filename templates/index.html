{% extends "base.html" %}

{% block title %}Accueil - Automatisation Aircall{% endblock %}

{% block content %}
<div class="row">
    <!-- En-tête de bienvenue -->
    <div class="col-12 text-center mb-5">
        <div class="py-5">
            <h1 class="display-4 text-primary mb-3">
                <i class="fas fa-robot me-3"></i>
                Automatisation Aircall → Monday.com
            </h1>
            <p class="lead text-muted">
                Interface web pour gérer et surveiller vos automatisations à distance
            </p>
            <div class="mt-4">
                <a href="{{ url_for('dashboard') }}" class="btn btn-primary btn-lg me-3">
                    <i class="fas fa-tachometer-alt me-2"></i>Tableau de bord
                </a>
                <a href="{{ url_for('automations') }}" class="btn btn-outline-primary btn-lg">
                    <i class="fas fa-cogs me-2"></i>Gérer les automatisations
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Vue d'ensemble du système -->
    <div class="col-lg-8 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Vue d'ensemble du système</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="display-6 text-primary me-3">
                                <i class="fas fa-phone"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Synchronisation Aircall</h6>
                                <small class="text-muted">Récupération automatique des appels</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="display-6 text-success me-3">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Création de tâches</h6>
                                <small class="text-muted">Génération automatique depuis les actions IA</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="display-6 text-info me-3">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Assignation intelligente</h6>
                                <small class="text-muted">Distribution automatique aux agents</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="display-6 text-warning me-3">
                                <i class="fas fa-link"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Liaison des contacts</h6>
                                <small class="text-muted">Association automatique appels-contacts</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <h6 class="text-primary mb-3">Fonctionnalités principales :</h6>
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Interface web responsive et moderne</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Contrôle en temps réel des automatisations</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Surveillance des logs et statistiques</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Planification automatique des tâches</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Notifications et alertes en temps réel</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Statut rapide -->
    <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i>Statut du système</h5>
            </div>
            <div class="card-body text-center">
                <div class="display-1 text-success mb-3" id="status-icon">
                    <i class="fas fa-circle"></i>
                </div>
                <h4 id="status-text">Vérification...</h4>
                <p class="text-muted" id="status-details">En cours de vérification</p>
                
                <hr class="my-3">
                
                <div class="row text-center">
                    <div class="col-6">
                        <div class="h4 text-primary" id="total-runs">-</div>
                        <small class="text-muted">Total exécutions</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 text-success" id="success-rate">-</div>
                        <small class="text-muted">Taux de succès</small>
                    </div>
                </div>
                
                <div class="mt-3">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-chart-line me-1"></i>Voir les détails
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Actions rapides -->
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Actions rapides</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="quick-start">
                        <i class="fas fa-play me-2"></i>Démarrer le planificateur
                    </button>
                    <button class="btn btn-success" id="quick-sync">
                        <i class="fas fa-sync-alt me-2"></i>Synchronisation complète
                    </button>
                    <button class="btn btn-info" id="quick-check">
                        <i class="fas fa-search me-2"></i>Vérifier l'état
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Informations système -->
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-server me-2"></i>Informations système</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-2">
                        <strong>Version :</strong>
                        <div class="text-muted">1.0.0</div>
                    </div>
                    <div class="col-6 mb-2">
                        <strong>Dernière mise à jour :</strong>
                        <div class="text-muted" id="last-update">-</div>
                    </div>
                    <div class="col-6 mb-2">
                        <strong>Statut API :</strong>
                        <div class="text-muted" id="api-status">Vérification...</div>
                    </div>
                    <div class="col-6 mb-2">
                        <strong>Connexions :</strong>
                        <div class="text-muted" id="connections">-</div>
                    </div>
                </div>
                
                <hr class="my-3">
                
                <div class="text-center">
                    <a href="{{ url_for('config') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-cog me-1"></i>Configuration
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section d'aide -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>Besoin d'aide ?</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <div class="display-4 text-warning mb-2">
                            <i class="fas fa-book"></i>
                        </div>
                        <h6>Documentation</h6>
                        <p class="text-muted small">Consultez le guide d'utilisation pour commencer</p>
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="display-4 text-info mb-2">
                            <i class="fas fa-tools"></i>
                        </div>
                        <h6>Dépannage</h6>
                        <p class="text-muted small">Vérifiez l'état du système et les logs</p>
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="display-4 text-success mb-2">
                            <i class="fas fa-headset"></i>
                        </div>
                        <h6>Support</h6>
                        <p class="text-muted small">Contactez l'équipe technique si nécessaire</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialisation de la page d'accueil
    initializeHomePage();
    
    // Mise à jour périodique du statut
    setInterval(updateQuickStatus, 15000); // Toutes les 15 secondes
});

function initializeHomePage() {
    // Mise à jour initiale
    updateQuickStatus();
    
    // Événements des boutons d'action rapide
    document.getElementById('quick-start').addEventListener('click', quickStartScheduler);
    document.getElementById('quick-sync').addEventListener('click', quickFullSync);
    document.getElementById('quick-check').addEventListener('click', quickSystemCheck);
}

function updateQuickStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            updateStatusDisplay(data);
            updateSystemInfo(data);
        })
        .catch(error => {
            console.error('Erreur mise à jour statut rapide:', error);
            updateStatusDisplay({ status: 'error', stats: { total_runs: 0, successful_runs: 0, failed_runs: 0 } });
        });
}

function updateStatusDisplay(data) {
    const statusIcon = document.getElementById('status-icon');
    const statusText = document.getElementById('status-text');
    const statusDetails = document.getElementById('status-details');
    const totalRuns = document.getElementById('total-runs');
    const successRate = document.getElementById('success-rate');
    
    // Mise à jour du statut
    let iconClass, statusClass, statusMessage, detailsMessage;
    
    switch(data.status) {
        case 'running':
            iconClass = 'fas fa-play-circle text-success';
            statusClass = 'text-success';
            statusMessage = 'Actif';
            detailsMessage = 'Planificateur en cours';
            break;
        case 'stopped':
            iconClass = 'fas fa-stop-circle text-secondary';
            statusClass = 'text-secondary';
            statusMessage = 'Arrêté';
            detailsMessage = 'En attente de démarrage';
            break;
        case 'error':
            iconClass = 'fas fa-exclamation-triangle text-danger';
            statusClass = 'text-danger';
            statusMessage = 'Erreur';
            detailsMessage = 'Problème détecté';
            break;
        default:
            iconClass = 'fas fa-question-circle text-warning';
            statusClass = 'text-warning';
            statusMessage = 'Inconnu';
            detailsMessage = 'Statut indéterminé';
    }
    
    statusIcon.className = `display-1 ${iconClass}`;
    statusText.className = `h4 ${statusClass}`;
    statusText.textContent = statusMessage;
    statusDetails.textContent = detailsMessage;
    
    // Mise à jour des statistiques
    totalRuns.textContent = data.stats.total_runs;
    
    if (data.stats.total_runs > 0) {
        const rate = Math.round((data.stats.successful_runs / data.stats.total_runs) * 100);
        successRate.textContent = `${rate}%`;
    } else {
        successRate.textContent = '0%';
    }
}

function updateSystemInfo(data) {
    // Mise à jour de la dernière mise à jour
    if (data.last_run) {
        const lastRun = new Date(data.last_run);
        document.getElementById('last-update').textContent = lastRun.toLocaleString('fr-FR');
    }
    
    // Mise à jour du statut API
    if (data.status === 'running') {
        document.getElementById('api-status').textContent = 'Connecté';
        document.getElementById('api-status').className = 'text-success';
    } else if (data.status === 'error') {
        document.getElementById('api-status').textContent = 'Erreur';
        document.getElementById('api-status').className = 'text-danger';
    } else {
        document.getElementById('api-status').textContent = 'Déconnecté';
        document.getElementById('api-status').className = 'text-secondary';
    }
    
    // Mise à jour des connexions (simulation)
    document.getElementById('connections').textContent = '1 active';
}

function quickStartScheduler() {
    const button = document.getElementById('quick-start');
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Démarrage...';
    
    fetch('/api/scheduler/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Planificateur démarré avec succès', 'success');
                updateQuickStatus();
            } else {
                showNotification('Erreur: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Erreur de connexion', 'error');
            console.error('Erreur démarrage rapide:', error);
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
}

function quickFullSync() {
    const button = document.getElementById('quick-sync');
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Exécution...';
    
    fetch('/api/run/full', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: 'Interface Web - Accueil' })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Synchronisation complète réussie', 'success');
            } else {
                showNotification('Erreur lors de la synchronisation', 'error');
            }
            updateQuickStatus();
        })
        .catch(error => {
            showNotification('Erreur de connexion', 'error');
            console.error('Erreur synchronisation rapide:', error);
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
}

function quickSystemCheck() {
    const button = document.getElementById('quick-check');
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Vérification...';
    
    // Simuler une vérification rapide
    setTimeout(() => {
        updateQuickStatus();
        showNotification('Vérification du système terminée', 'success');
        button.disabled = false;
        button.innerHTML = originalText;
    }, 2000);
}

function showNotification(message, type) {
    // Créer une notification toast
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Ajouter au conteneur de toasts
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toast);
    
    // Afficher le toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Supprimer après fermeture
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>
{% endblock %}
