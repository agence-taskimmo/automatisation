{% extends "base.html" %}

{% block title %}Tableau de bord - Automatisation Aircall{% endblock %}

{% block content %}
<div class="row">
    <!-- En-tête du tableau de bord -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-tachometer-alt me-2"></i>Tableau de bord</h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success" id="start-scheduler">
                    <i class="fas fa-play me-1"></i>Démarrer
                </button>
                <button type="button" class="btn btn-danger" id="stop-scheduler">
                    <i class="fas fa-stop me-1"></i>Arrêter
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Statut du système -->
    <div class="col-md-6 col-lg-3 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="display-4 text-primary mb-2">
                    <i class="fas fa-robot"></i>
                </div>
                <h5 class="card-title">Statut du système</h5>
                <div class="badge bg-success fs-6" id="system-status">Arrêté</div>
                <p class="text-muted mt-2" id="system-details">En attente</p>
            </div>
        </div>
    </div>

    <!-- Statistiques globales -->
    <div class="col-md-6 col-lg-3 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="display-4 text-info mb-2">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h5 class="card-title">Total des exécutions</h5>
                <div class="display-6 text-info" id="total-runs">0</div>
                <p class="text-muted mt-2">Depuis le début</p>
            </div>
        </div>
    </div>

    <!-- Exécutions réussies -->
    <div class="col-md-6 col-lg-3 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="display-4 text-success mb-2">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h5 class="card-title">Succès</h5>
                <div class="display-6 text-success" id="successful-runs">0</div>
                <p class="text-muted mt-2">Exécutions réussies</p>
            </div>
        </div>
    </div>

    <!-- Exécutions échouées -->
    <div class="col-md-6 col-lg-3 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="display-4 text-danger mb-2">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h5 class="card-title">Échecs</h5>
                <div class="display-6 text-danger" id="failed-runs">0</div>
                <p class="text-muted mt-2">Exécutions échouées</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Dernière exécution -->
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Dernière exécution</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <strong>Date :</strong>
                        <div id="last-run-date">Aucune</div>
                    </div>
                    <div class="col-6">
                        <strong>Heure :</strong>
                        <div id="last-run-time">-</div>
                    </div>
                </div>
                <div class="mt-3">
                    <strong>Prochaine exécution :</strong>
                    <div id="next-run-info">Non programmée</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Actions rapides</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="run-full-sync">
                        <i class="fas fa-sync-alt me-2"></i>Synchronisation complète
                    </button>
                    <button class="btn btn-outline-primary" id="run-sync-only">
                        <i class="fas fa-phone me-2"></i>Synchronisation Aircall
                    </button>
                    <button class="btn btn-outline-success" id="run-tasks-only">
                        <i class="fas fa-tasks me-2"></i>Création de tâches
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Logs en temps réel -->
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-terminal me-2"></i>Logs en temps réel</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="clear-logs">
                        <i class="fas fa-trash me-1"></i>Effacer
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="refresh-logs">
                        <i class="fas fa-sync-alt me-1"></i>Actualiser
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="log-container" id="live-logs">
                    <div class="text-muted text-center py-4">
                        <i class="fas fa-spinner fa-spin me-2"></i>Chargement des logs...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de résultat -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">Résultat de l'exécution</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultModalBody">
                <!-- Contenu dynamique -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Scripts spécifiques au tableau de bord
document.addEventListener('DOMContentLoaded', function() {
    // Initialisation des événements
    initializeDashboardEvents();
    
    // Mise à jour initiale
    updateDashboard();
    
    // Mise à jour périodique
    setInterval(updateDashboard, 10000); // Toutes les 10 secondes
});

function initializeDashboardEvents() {
    // Boutons de contrôle du planificateur
    document.getElementById('start-scheduler').addEventListener('click', startScheduler);
    document.getElementById('stop-scheduler').addEventListener('click', stopScheduler);
    
    // Actions rapides
    document.getElementById('run-full-sync').addEventListener('click', () => runAutomation('full'));
    document.getElementById('run-sync-only').addEventListener('click', () => runAutomation('sync'));
    document.getElementById('run-tasks-only').addEventListener('click', () => runAutomation('tasks'));
    
    // Boutons de logs
    document.getElementById('clear-logs').addEventListener('click', clearLogs);
    document.getElementById('refresh-logs').addEventListener('click', refreshLogs);
}

function updateDashboard() {
    // Mise à jour du statut
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            updateSystemStatus(data);
            updateStatistics(data);
            updateTimingInfo(data);
        })
        .catch(error => console.error('Erreur mise à jour dashboard:', error));
    
    // Mise à jour des logs
    refreshLogs();
}

function updateSystemStatus(data) {
    const statusElement = document.getElementById('system-status');
    const detailsElement = document.getElementById('system-details');
    const indicator = document.getElementById('status-indicator');
    
    let statusClass, statusText, detailsText;
    
    switch(data.status) {
        case 'running':
            statusClass = 'bg-success';
            statusText = 'En cours';
            detailsText = 'Planificateur actif';
            indicator.className = 'fas fa-circle text-success me-1';
            break;
        case 'stopped':
            statusClass = 'bg-secondary';
            statusText = 'Arrêté';
            detailsText = 'En attente de démarrage';
            indicator.className = 'fas fa-circle text-secondary me-1';
            break;
        case 'error':
            statusClass = 'bg-danger';
            statusText = 'Erreur';
            detailsText = data.stats.last_error || 'Erreur inconnue';
            indicator.className = 'fas fa-circle text-danger me-1';
            break;
        default:
            statusClass = 'bg-warning';
            statusText = 'Inconnu';
            detailsText = 'Statut indéterminé';
            indicator.className = 'fas fa-circle text-warning me-1';
    }
    
    statusElement.className = `badge ${statusClass} fs-6`;
    statusElement.textContent = statusText;
    detailsElement.textContent = detailsText;
}

function updateStatistics(data) {
    document.getElementById('total-runs').textContent = data.stats.total_runs;
    document.getElementById('successful-runs').textContent = data.stats.successful_runs;
    document.getElementById('failed-runs').textContent = data.stats.failed_runs;
}

function updateTimingInfo(data) {
    if (data.last_run) {
        const lastRun = new Date(data.last_run);
        document.getElementById('last-run-date').textContent = lastRun.toLocaleDateString('fr-FR');
        document.getElementById('last-run-time').textContent = lastRun.toLocaleTimeString('fr-FR');
    } else {
        document.getElementById('last-run-date').textContent = 'Aucune';
        document.getElementById('last-run-time').textContent = '-';
    }
    
    if (data.next_run) {
        const nextRun = new Date(data.next_run);
        document.getElementById('next-run-info').textContent = nextRun.toLocaleString('fr-FR');
    } else {
        document.getElementById('next-run-info').textContent = 'Non programmée';
    }
}

function startScheduler() {
    fetch('/api/scheduler/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Planificateur démarré avec succès', 'success');
                updateDashboard();
            } else {
                showNotification('Erreur: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Erreur de connexion', 'error');
            console.error('Erreur démarrage planificateur:', error);
        });
}

function stopScheduler() {
    fetch('/api/scheduler/stop', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Planificateur arrêté avec succès', 'success');
                updateDashboard();
            } else {
                showNotification('Erreur: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Erreur de connexion', 'error');
            console.error('Erreur arrêt planificateur:', error);
        });
}

function runAutomation(type) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Désactiver le bouton
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Exécution...';
    
    const endpoint = type === 'full' ? '/api/run/full' : `/api/run/${type}`;
    
    fetch(endpoint, { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: 'Interface Web' })
    })
        .then(response => response.json())
        .then(data => {
            showResultModal(data);
            if (data.success) {
                showNotification('Automatisation exécutée avec succès', 'success');
            } else {
                showNotification('Erreur lors de l\'exécution', 'error');
            }
            updateDashboard();
        })
        .catch(error => {
            showNotification('Erreur de connexion', 'error');
            console.error('Erreur exécution automatisation:', error);
        })
        .finally(() => {
            // Réactiver le bouton
            button.disabled = false;
            button.innerHTML = originalText;
        });
}

function showResultModal(result) {
    const modal = new bootstrap.Modal(document.getElementById('resultModal'));
    const title = document.getElementById('resultModalTitle');
    const body = document.getElementById('resultModalBody');
    
    title.textContent = `Résultat: ${result.script || 'Synchronisation complète'}`;
    
    let bodyContent = '';
    if (result.success) {
        bodyContent = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                Exécution réussie à ${new Date(result.execution_time).toLocaleString('fr-FR')}
            </div>
        `;
        
        if (result.output) {
            bodyContent += `
                <h6>Sortie:</h6>
                <pre class="bg-light p-3 rounded"><code>${result.output}</code></pre>
            `;
        }
    } else {
        bodyContent = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Erreur lors de l'exécution
            </div>
            <p><strong>Erreur:</strong> ${result.error}</p>
        `;
    }
    
    body.innerHTML = bodyContent;
    modal.show();
}

function refreshLogs() {
    fetch('/api/logs')
        .then(response => response.json())
        .then(data => {
            const logsContainer = document.getElementById('live-logs');
            
            if (data.logs && data.logs.length > 0) {
                let logsHtml = '';
                data.logs.forEach(log => {
                    const logClass = log.includes('ERROR') ? 'text-danger' : 
                                   log.includes('WARNING') ? 'text-warning' : 
                                   log.includes('INFO') ? 'text-info' : 'text-dark';
                    logsHtml += `<div class="log-line ${logClass}">${log}</div>`;
                });
                logsContainer.innerHTML = logsHtml;
                
                // Scroll vers le bas
                logsContainer.scrollTop = logsContainer.scrollHeight;
            } else {
                logsContainer.innerHTML = '<div class="text-muted text-center py-4">Aucun log disponible</div>';
            }
        })
        .catch(error => {
            console.error('Erreur récupération logs:', error);
            document.getElementById('live-logs').innerHTML = 
                '<div class="text-danger text-center py-4">Erreur lors du chargement des logs</div>';
        });
}

function clearLogs() {
    document.getElementById('live-logs').innerHTML = 
        '<div class="text-muted text-center py-4">Logs effacés</div>';
}

function showNotification(message, type) {
    // Créer une notification toast
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Ajouter au conteneur de toasts
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toast);
    
    // Afficher le toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Supprimer après fermeture
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>
{% endblock %}
